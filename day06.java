import java.util.*;
import java.util.List;
import java.util.regex.*;
import java.util.stream.*;
import java.awt.*;

class Day6 {
	
	public static void main(String[] args) {
		System.out.println("Sample phase one result, expected: 41, actual: " + countSteps(parse(sample)));
		System.out.println("Actual phase one result, expected: 4776, actual: " + countSteps(parse(input)));
		System.out.println("Sample phase two result, expected: 6, actual: " + countLoopPossibilities(parse(sample)));
		System.out.println("Actual phase two result, expected: 1586, actual: " + countLoopPossibilities(parse(input)));
	}
	
	public static int countLoopPossibilities(char[][] grid) {
		var result = 0;
		
		var guardStartingPosition = findGuard(grid);
		countSteps(grid); //mark walked path with X
		
		for (int i = 0; i < grid.length; i++) {
			for (int h = 0; h < grid.length; h++) {
				grid[guardStartingPosition.x][guardStartingPosition.y] = '^';//move guard back into original position
				var isWalkedTile = grid[i][h] == 'X';
				var isStartingPosition = guardStartingPosition.x == i && guardStartingPosition.y == h;
				if (isWalkedTile && !isStartingPosition) { 
					grid[i][h] = '#';//simulate obstruction
					try {
						countSteps(grid);	
					} catch (RuntimeException e) {
						if (e.getMessage() == "loop") {
							result +=1;
						} else {
							//finished lazy programmer
							break;
						}
					} finally {
						grid[i][h] = 'X';//remove obstruction
					}
					
				}
			}
		}
		return result;
	}
	
	public static int countSteps(char[][] grid) {
		Point g = findGuard(grid);
		int stepsTaken = 0;
		int direction = 0;// 0 UP 1 RIGHT 2 DOWN 3 LEFT
		Set<String> stepsAlreadyTakenWithDirection = new HashSet<String>();
		
		try {
			long h = 0;
			while (true) {
				
				if (grid[g.x][g.y] != 'X') {
					grid[g.x][g.y] = 'X';
					stepsTaken += 1;		
				}
				
				int i = 0;
				while (peekStep(grid, g, direction) == '#') {
					i++;
					if (i > 3)  { 
						throw new RuntimeException("panic");
					}
					direction ++;
					if (direction > 3) direction = 0;
				}
				
				if (direction == 0) { //UP
					g.x = g.x - 1;
				} else if (direction == 1) { //RIGHT
					g.y = g.y + 1;
				} else if (direction == 2){ //DOWN
					g.x = g.x + 1;
				} else if (direction == 3){ //LEFT
					g.y = g.y - 1;
				} else {
					throw new RuntimeException("panic!");
				}
				
				var stepId = g.x + ":" + g.y + ":" + direction;
				if (stepsAlreadyTakenWithDirection.contains(stepId)) {
					throw new RuntimeException("loop");
				}
				
				h++;
				if (h % 10000 == 0) {
					stepsAlreadyTakenWithDirection.add(stepId);
				}
				
			}
		} catch(ArrayIndexOutOfBoundsException $expectedLazyProgrammer) {
			//do nothing
		}
		
//		for (char[] row : grid) {
//			for (char cell : row) {
//				System.out.print(cell + " "); // Add space between characters
//			}
//			System.out.println(); // Move to the next line after each row
//		}
		
		return stepsTaken;
	}
	
	public static char peekStep(char[][] grid, Point g, int direction) {
		if (direction == 0) { //UP
			return grid[g.x - 1][g.y];
		} else if (direction == 1) { //RIGHT
			return grid[g.x][g.y + 1];
		} else if (direction == 2){ //DOWN
			return grid[g.x + 1][g.y];
		} else if (direction == 3){ //LEFT
			return grid[g.x][g.y - 1];
		} else {
			throw new RuntimeException("panic!");
		}
	}
	
	
	public static Point findGuard(char[][] grid) {
		for(int i =0; i < grid.length; i++) {
			for (int h  =0; h < grid[i].length; h++) {
				if (grid[i][h] == '^') return new Point(i,h);
			}
		}
		
		return null;
	}
	
	public static char[][] parse(String input) {
		return input.lines()
			.map(String::toCharArray)
			.toArray(char[][]::new);
	}
	
	static String sample =	"""
								....#.....
								.........#
								..........
								..#.......
								.......#..
								..........
								.#..^.....
								........#.
								#.........
								......#...
								""";
	
	static String input =	"""
.........#..................#.......#...............#..................................#.....................................#....
..#....................................#...#......#....................#..........................................................
..........................................................#..#.#................#............#....................#...............
...........................................................#......................................................#...............
............................#..........#................................................#............#.#....................#.....
...........#............................#............................................#...........................................#
......#..................#..#...........#.......................#..........#.....................#...........#...#......#.....#...
...#........................................................................................................#.............#.......
.......................#....................................#.....................#...#.#.....##.........................#........
..............#........#..............................................................................#..........#........#.......
.#........................................................................#....#..#....#.....................................#....
..........#.....................#....#.#.......................#................#.#.............#.......#.......#..........#......
......#..#...............................#.###......................................................#...#.........................
...............................................#....................#...#.......................#...........#...#.................
....#...#..#.............#................................................................#.......................................
...............#...#............#....................#.............#................#.......#....#.......................#........
.........#..........................#............#..............................................................#.#...............
..........................##..............................#....................................#..................................
.......#..##.........................#..............#..#......#..............#...............................##...................
.............................................#........................................................................#....#......
.........................#.......#.......#.......##.#.........#...................................................................
#......................................................................................#.......#......#.#................#......#.
...#.............#....#.............#.....................#................................................................#......
...........#.....................#............................#..............................#.....#........#.....................
.................#....#.#............#.....#................#.....................#..#............................................
..........................#......................#...............#.#...#..............................#.........#.................
...........................................................#......................................................#......#........
........#.........................#.................................#.....................................#.......................
....................#........#.....................................#...............#................#.......................#.....
....#...............#.............................................................................................................
##..................................................................................#.....................................#..#....
........................#..............#......#...................................#.........#.......#.....#.....#.................
.........#.............#......................#............#.......................................................#..........#...
.....#...............#......................................................................#.........#..................#........
....................#...#..............#...............#.............#.............#......#..#......#................#......#.....
............#..........................................#.........................................#........#.......................
.......#.....#........#....................#...............#............................................................#.........
..................#..#.............................................#........#..........................................#..........
...................................#...............................................................#.......#................#.#...
.......................#.....#.........#..................##........#.............................................................
.....#.................................................................................#............#........................#....
....#..........#.........#................................#.....................................#..................##.............
.#.........#..............#.................#...............................................#...............................#.....
........................#.......................................................#.....#................#..............#...........
.........................#.............................#.......#..................##..........................................#...
...................#...................#............#......#......................##........................#...#.....#...........
......#......#....#......................................................................................#........................
#............#........##............................#............................................#....#.......#.................#.
...........................................................#..............................................#.......#...#...........
...##...#............#.....#...............#..................#....................#..............#.............................#.
.....................................................................#................................#.......#.................#.
......#......#.......................................................#....#.................#.....................#...#.#....#.#..
...................#.........#..............#.................................#...#.......#.......................................
........##.....#.......#............................#...................................................................#.........
...................................#.........................................................................#...#...........#....
....#.....................................#......................................................#...#..........#.....#...........
..................................................................................................#........#....................#.
.........#....................##.................................#.......................#........#......#......................#.
.....#.....#....#............#..............#....#.........#............#.#...............#.......................#...............
...................................#.......................#..........................#.....................................#....#
..........#....#...........#.........#..............#.....#................................................#.........#............
...#.........#....................................................................................................................
.#.........................#........................................#.....#...................................#.............#.....
.......................#...#...#...#.......##..................##......................................#........................#.
............................................#....#..........................................##............................#.......
..#.................................................................#....#....#....##...........................................#.
.............#........#.#........#.....................##.....................................................#..#................
............................................##.......................................................................##...........
.........#...................#.................................#....#.#.............................#......#.#.#.....#.........#..
.........................#...........#...........#............................................#......#..................#.........
#.............................##...............#..........#...................#......................................#........#...
...................#.............................................................................................#.......#........
..........................................#.#......................................#........#...........##.......................#
...................#........#.#......#....................................#.......#...........................#..................#
......#................................................................................................#..........................
......................###.............#...................#.#...............................................#.....................
.....#......#......#.....#.#..................#.#...#.....................................................................#.......
.............................................#..............#....................##...............................................
.........................................#..#.............#................................................#...................#.#
........#............................#.................................................#..#.......................................
............#.............................#......................................#..........................##...#................
...................#.........#..................................................................#.............#...................
..#..#..............#....................#...................................................................#....................
............................#..................#..................................................................................
.........................#.....................................................................................#...............#..
.........#....................#.#.............##..................#...#...........................................................
........#..............................#..........................................#.#.........................#...................
.#........#....................##.............................................#............#......................................
...#.....................................#......#.#..#.....#............................#.......................................#.
....................#.........................................#.#.................................#.........#................#....
..............#..........#......#.........................#..#..................#..#...................#.................#...#....
................#..........................................#.............................#......#..............#.#...##...........
........................#.....#.......................#...#................#.......#................#.............................
........#..#..........#....#..#.............................................#...................#........#.................#.#....
...........................#.............................................................#..#................................#.#..
...........#.............#........................................#.^.................................................#...........
..........#.#..#......#........................................................................................#....#.............
...............#......#...#....#..................................#.......#.......................................................
..........##...##....#.....................#...#................................................................#......#..........
.............................................#................................................................................###.
........#.......#..........#....#....................#....................#....#.....#............................................
......#.............................................................................#...........##...#......##....................
.......#.............................#............#.......................#............#...#......................................
..#........#.....#......................................................................................................#.........
.....#....#......................#.....................................................................#..........................
.#.......#...........#....#.......#..............#...#..............#........#..........##.....#......#.................#.........
.............#.#....................................................#........#..............#.....#......................#...#....
...........#.............................................#...........................#.........##................#..#.....#.......
.........................................#.................................................................#.......#.#............
...............#....................#..........................#.............#......#....#...#..............#..................#..
........#...............#.........................................................................................................
..............................#............................#.#...................................#........#................#......
...........#........#.............................#...............................#................#.............#........#.......
.............................#...#..#...........#...........#.............................#..............................#........
......................................................................................................................#........#..
..............##...........#..........................................#...#..............#........................................
..............#.................#......................................................#..#........#..........................#...
..............................................#.......................#........................................................#..
.................#..#...................#..............................#.......................................#.#......#.........
...........#..........#................#.............#...................................................#.......#.....#..........
...#...#...............................................................................................#................#..#.#.#..
...#.....................................................................................#...............................#........
..........................#............................#.#..#..................#.#.......................#.#................##...#
...............................................................................................#....##............................
............................................#....................#....................................................#...........
...............#.......#...#.................................#.......................................#...#..#.#...................
.......#.....#.....#..................#..............#................#..........#........#.......................................
...#...#..........##....................#.......#.......#...........................#....................................#.....#..
..................................................#...#.#...#.........#.#.#.......##.....##.................................#.....
...#..#..........................#..#...........................#...............#.....#.......#............................#......
								""";
}

